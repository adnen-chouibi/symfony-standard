<!DOCTYPE html>
<html>
    <head>

        <!-- To render these slides you need Slippy https://github.com/Seldaek/slippy -->

        <title>Advanced Symfony2</title>

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <meta name="author" content="Lukas Kahwe Smith, Tobias Schultze" />
        <meta name="date" content="2013-09-05" />
        <meta name="venue" content="Bol, Croatia" />

        <!-- Slippy core file and dependencies -->
        <script type="text/javascript" src="slippy/src/jquery.min.js"></script>
        <script type="text/javascript" src="slippy/src/jquery.history.js"></script>
        <script type="text/javascript" src="slippy/src/slippy.js"></script>
        <!-- Slippy structural styles -->
        <link type="text/css" rel="stylesheet" href="slippy/src/slippy.css"/>
        <!-- Slippy theme -->
        <link type="text/css" rel="stylesheet" href="slippy/src/slippy-pure.css"/>
        <!-- Syntax highlighting core file  -->
        <script type="text/javascript" src="slippy/src/highlighter/shCore.js"></script>
        <!-- Syntax highlighting brushes, remove those you don't need -->
        <script type="text/javascript" src="slippy/src/highlighter/shBrushPhp.js"></script>
        <script type="text/javascript" src="slippy/src/highlighter/shBrushJScript.js"></script>
        <script type="text/javascript" src="slippy/src/highlighter/shBrushXml.js"></script>
        <!-- Syntax highlighting styles-->
        <link type="text/css" rel="stylesheet" href="slippy/src/highlighter/shCore.css"/>
        <link type="text/css" rel="stylesheet" href="slippy/src/highlighter/shThemeEclipse.css"/>

        <style type="text/css">
            body > * {
                font-size: 1.2em;
            }

            body {
                background: #fff;
            }

            div.syntaxhighlighter {
                background: #aaa !important;
            }

            span.file {
                font-size: 0.8em;
                color: #f00;
                float: right;
                margin: -.2em .5em 0 0;
            }

            .smallcode {
                font-size: 0.8em;
            }

            strong {
                color: #662222;
            }

            li {
                line-height: 1.2em;
            }
            .footer, h1 {
                background: #eeeeee;
                border: solid #cccccc 1px;
                border-radius: 5px;
                padding: 8px;
            }
            .section h1 {
                background: #fff;
                border: none;
                font-size: 2em;
            }
            .footer {
                background: #fff;
                margin: 10px;
                margin-top: 0;
                width: 97%;
            }
        </style>
        <!-- Slippy init code -->
        <script type="text/javascript">
            $(function() {
                $(".slide").slippy({
                });
                SyntaxHighlighter.all();
            });
        </script>
    </head>

    <body>

        <div class="footer">
            <span class="left"><a href="http://ezsummercamp.com/">eZ Publish Summer Camp 2013</a><br/><a href="http://ezsummercamp.com/program/advanced_symfony2">Advanced Symfony2</a></span>
            <span class="right"><a href="http://pooteeweet.org/">Lukas Kahwe Smith</a><br/><a href="https://github.com/Tobion">Tobias Schultze</a></span>
            <hr class="defloat" />
        </div>

        <div class="slide section">
            <h1>Advanced Symfony2</h1>
            <h2>Workshop</h2>
            <ul>
                <li>kernel - step through a request with Xdebug</li>
                <li>core events

- example: leute einen listener schreiben lassen (z.B. kernel.request listener der HEAD requests nach der security schon direkt beantwortet)
- custom events</li>
                <li>routing</li>
                <li>controller creation
- ControllerResolver
- kernel.controller</li>
                <li>bundle bootstrapping
- extension: service decorating
- prepend extension
- Configuration class
- example: compiler pass irgendwas mit tagging</li>
                <li>dependency injection container
- scopes
- synthetic services, private/public, lazy services
- example: service inheritance base abstract controller</li>
                <li>profiler
- example data collector: displaying requests made to some (external) API</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Kernel</h1>
            <ul>
                <li>Overview</li>
                <li>Request processing</li>
                <li>Events</li>
                <li>Controller Resolver</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Kernel overview</h1>
            <ul>
                <li>Responsible to turn a Request instance into a Response instance</li>
                <li>Must implement the <a href="https://github.com/symfony/HttpKernel/blob/master/HttpKernelInterface.php#L24" target="_new">HttpKernelInterface</a></li>
                <li>Custom logic is implemented in Bundles</li>
                <li>Makes extensive use of events to allow for extensibility</li>
                <li>Note: A Request might lead to any number of Sub-Requests</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Kernel request processing</h1>
            <ol>
                <li>Bootstrap all registered Bundles and the application configuration</li>
                <li>Trigger kernel.request event, if a Response was set jump to 8</li>
                <li>Use the ControllerResolver to determine the controller to execute</li>
                <li>Trigger the kernel.controller event</li>
                <li>Kernel calls the controller</li>
                <li>Trigger kernel.view event, if the Controller does not return a Response</li>
                <li>Trigger kernel.response event</li>
                <li>Return the Response</li>
            </ol>
        </div>

        <div class="slide">
            <h1>Kernel Events</h1>
            <ul>
                <li>kernel.request</li>
                <li>kernel.controller</li>
                <li>kernel.view (*)</li>
                <li>kernel.response</li>
                <li>kernel.terminate (*)</li>
                <li>kernel.exception (*)</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Configuring a Kernel Events</h1>

            <pre class="brush: js">
                acme.demo.request_head_listener:
                    class: Acme\DemoBundle\EventListener\MyListener
                    tags:
                        - {
                            name: kernel.event_listener,
                            event: kernel.request,
                            method: onKernelRequest,
                            priority: -129
                        }
            </pre>
        </div>

        <div class="slide">
            <h1>Listener can subscribe to events themselves</h1>
            <pre class="brush: php">
                class MyListener implements EventSubscriberInterface
                {
                    public static function getSubscribedEvents()
                    {
                        return array(
                            KernelEvents::REQUEST => array(
                                'onKernelRequest', -129
                            )
                        );
                    }
                }
            </pre>
            <pre class="brush: js">
                acme.demo.request_head_listener:
                    class: Acme\DemoBundle\EventListener\MyListener
                    tags:
                        - {
                            name: kernel.event_subscribe
                        }
            </pre>
        </div>

        <div class="slide">
            <h1>Exercise: Write a custom listener</h1>
            <ul>
                <li>Scenario: We are using a reverse proxy in front of a website with a complex authentication and permission scheme</li>
                <li>Solution: Rewrite all GET Requests to HEAD Requests, check for a 200 Response before serving content from the cache</li>
                <li>Implementation: Write a listener for the kernel.request event. Ensure this listener has a lower priority than the firewall listener (priority 8). Return a 200 Response for any HEAD Request.</li>
                <li>Documentation: <a href="http://symfony.com/doc/current/book/internals.html#events">Internals: Events</a></li>
            </ul>
        </div>

        <div class="slide">
            <h1>Kernel Controller Resolver</h1>
            <ul>
                <li>Determines the controller to load and what action method to call by reading Request::get('_controller')</li>
                <li>Creates the controller instance if necessary</li>
                <li>Additionally determines the parameters to pass to the controller action method</li>
                <li>Note the kernel.controller event is triggered between determining and creating the controller and determining the action method parameters</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Routing</h1>
            <ul>
                <li>Required and optional placeholders</li>
                <li>Route requirements</li>
                <li>Host matching</li>
                <li>Custom route loader</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Required and optional placeholders</h1>

            <p>Placeholders are only optional if they have a default and are at the end of the pattern.</p>
            <p>For multiple optional placeholders each one must have a default and be separated by a single delimiter.</p>

            <pre class="brush: js">
                blog:
                    path:      /blog/{page}
                    defaults:  { _controller: AcmeDemoBundle:Blog:index, page: 1 }
            </pre>

            <p>Will match <code>/blog</code> (page=1) and <code>/blog/3</code> (page=3), but not <code>/blog/</code>.</p>

            <pre class="brush: js">
                blog_categories:
                    path:      /blog/{category1}/{category2}/{category3}
                    defaults:  { _controller: AcmeDemoBundle:Blog:byCategories, category2: "", category3: "" }
            </pre>

            <p>Will match <code>/blog/php</code> and <code>/blog/php/symfony</code> and<code>/blog/php/symfony/ezpublish</code>, but not <code>/blog</code>.</p>

            <!-- <p>Sometimes it is necessary to create multiple routes for the same thing to achieve the desired result. For example for optional parts in the middle of the path.</p> -->
            <p>Do you see a problem when using both these routes?</p>
        </div>

        <div class="slide">
            <h1>Route requirements</h1>

            <ul>
                <li><code>/blog/php</code> will match route "blog" (page=php) instead of "blog_categories".</li>
                <li>Route order matters! Route matching happens the order you define them. So if you have routes that overlap, later routes might never match.</li>
                <li>Solution: Careful crafting of route order, paths and requirements.</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Default route requirements</h1>

            <p>By default, a route matches any HTTP method, any scheme and any host/domain.</p>

            <pre class="brush: js">
                blog_article:
                    path:      /blog/{slug}.{_format}
                    defaults:  { _controller: AcmeDemoBundle:Blog:article, _format: html }
            </pre>

            <p>What is the default requirement (regex) for <code>slug</code> and <code>_format</code>?</p>

            <ul>
                <li>app/console router:debug blog_article</li>
                <li>Path-Regex: <code>#^/blog/(?P&lt;slug&gt;[^/\.]++)(?:\.(?P&lt;_format&gt;[^/]++))?$#s</code></li>
                <li>slug: <code>[^/\.]++</code></li>
                <li>_format: <code>[^/]++</code></li>
                <li><code>++</code> is a possessive quantifier</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Custom route requirements</h1>

            <pre class="brush: js">
                blog_archive:
                    path:      /blog/{date}
                    defaults:  { _controller: AcmeDemoBundle:Blog:byDate }
                    methods:   [GET, PUT] # HEAD implicit
                    schemes:   https
                    requirements:
                        date:  \d{4}-\d{1,2}-\d{1,2}
            </pre>

            <p>By overriding the default requirement, you can also allow a "/" character in a placeholder.</p>
        </div>

        <div class="slide">
            <h1>Host matching</h1>

            <pre class="brush: js">
                user_profile:
                    path:     /
                    host:     {user}.%domain%
                    defaults: { _controller: AcmeDemoBundle:User:profile }
            </pre>

            <pre class="brush: js">
                parameters:
                    domain: example.com
            </pre>

            <p>The host option uses the same pattern style like path. But it doesn't support optional placeholders yet.</p>
            <p>It makes the domain configurable via service container parameters so you can change it depending on the environment.</p>

            <pre class="brush: xml">
                <a href="{{ path('user_profile', {'user': user.slug}) }}">Profile</a>
            </pre>

            <p>It will automatically generate an absolute URL when the resulting host is different from the current.</p>
            <!-- <p>So you can change the route definition and for example put the user placeholder in the path without needing to change your code/template.
            This abstraction is one of the main points of using the routing component.</p> -->
        </div>

        <div class="slide">
            <h1>Exercise: Write a custom route loader</h1>

            <ul>
                <li>Scenario: We have controllers in a filesystem like
<pre style="margin: 10px 0">
├── Controller
│   ├── about
│   │   ├── ezpublish.php
│   │   └── symfony.php
│   └── news.php
</pre>
                (see FilesystemRoutingBundle) and want to make them accessible <em>automatically</em> via URL paths that represent this directory structure
                (<code>/about/ezpublish</code>, <code>/about/symfony</code>, <code>/news</code>).
                </li>
            </ul>
        </div>

        <div class="slide">
            <h1>Exercise: Write a custom route loader</h1>

            <ul>
                <li>Solution: Create a route loader that loads routes based on the file system structure. The directories and files represent the URL path segments.
                The file itself contains the Controller class and a "getAction" method that is executed for a GET request on the corresponding route. The routes
                are static because placeholders do not exist.</li>
                <li>Implemenation: The route loader accepts imports with "type: filesystem" and interates over all controller files in a directory and adds routes with the corresponding URL path for them.</li>
                <li>Documentation: <a href="http://symfony.com/doc/current/cookbook/routing/custom_route_loader.html">Custom route loader</a></li>
            </ul>
        </div>

        <div class="slide">
            <h1>Bundles</h1>
            <ul>
                <li>Bootstrapping</li>
                <li>Extensions</li>
                <li>Configuration</li>
                <li>Compiler passes</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Bundle bootstrapping</h1>
            <ul>
                <li>Call the Bundles boot() method</li>
                <li>Determine if the Container needs to be generated (missing or if in debug mode and any config file has changes)</li>
                <ul>
                    <li>call prepend() method on any Bundle that has an Extension that implements PrependExtensionInterface</li>
                    <li>call load() method on any Bundle that has an Extension</li>
                </ul>
                <li>Serialize the Container to PHP</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Bundle extensions</h1>
            <ul>
                <li>Optional way to add Bundle specific services to the Container</li>
                <li>load() method should use the Configuration class to validate and merge the configuration</li>
                <li>Create services and parameters in the Container by loading configuration files or by code</li>
                <li>PrependExtensionInterface::prepend() method can change the defaults from other Bundles</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Configuration</h1>

            <p>Handles applying default values, validation and merging of application configuration.</p>

            <pre class="brush: php">
              public function getConfigTreeBuilder()
              {
                $treeBuilder = new TreeBuilder();
                $rootNode = $treeBuilder->root('acme_demo');

                $rootNode
                  ->children()
                    ->scalarNode('hello')
                        ->defaultValue('world')->end()
                    ->fixXmlConfig('filter', 'filters')
                    ->children()
                      ->booleanNode('foo')->defaultFalse()->end()
                      ->scalarNode('bar')->defaultNull()->end()
                    ->end()
                  ->end();

                return $treeBuilder;
              }
            </pre>
        </div>

        <div class="slide">
            <h1>Bundle compiler passes</h1>
            <ul>
                <li>..</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Dependency Injection Container</h1>
            <ul>
                <li>Scopes</li>
                <li>Synthetic services</li>
                <li>Private/public</li>
                <li>Lazy services</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Exercise: Define a template controller service</h1>
            <ul>
                <li>Scenario: We are defining controllers as services and always have a similar set of dependencies</li>
                <li>Solution: We define an abstract service which gets our standard dependencies injected</li>
                <li>Implementation: Define the service like you normally do and simply set "abstract" to "true", reuse the abstract service with the "parent" setting.</li>
                <li>Documentation: <a href="http://symfony.com/doc/current/components/dependency_injection/parentservices.html">Managing Common Dependencies with Parent Services</a></li>
            </ul>
        </div>

        <div class="slide">
            <h1>Data Collector</h1>
            <ul>
                <li>..</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Exercise: Define a data collector that counts the calls to a custom service</h1>
            <ul>
                <li>Scenario: We have a service we use across the entire application and we want to get a better overview how often it is called.</li>
                <li>Solution: We add a data collector that is notified inside the service to collect the information</li>
                <li>Implementation: Define a data collector service, define a dummy service that allows registering loggers that get notified when the service is used. Inject that service into the data collector so that it can register itself as a logger.</li>
                <li>Documentation: <a href="http://symfony.com/doc/current/cookbook/profiler/data_collector.html">How to create a custom Data Collector</a></li>
                <li>Extra credit: Define profiler templates to display which class called the service how often.</li>
            </ul>
        </div>

    </body>
</html>
