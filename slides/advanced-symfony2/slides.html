<!DOCTYPE html>
<html>
    <head>

        <!-- To render these slides you need Slippy https://github.com/Seldaek/slippy -->

        <title>Advanced Symfony2</title>

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <meta name="author" content="Lukas Kahwe Smith, Tobias Schultze" />
        <meta name="date" content="2013-09-05" />
        <meta name="venue" content="Bol, Croatia" />

        <!-- Slippy core file and dependencies -->
        <script type="text/javascript" src="slippy/src/jquery.min.js"></script>
        <script type="text/javascript" src="slippy/src/jquery.history.js"></script>
        <script type="text/javascript" src="slippy/src/slippy.js"></script>
        <!-- Slippy structural styles -->
        <link type="text/css" rel="stylesheet" href="slippy/src/slippy.css"/>
        <!-- Slippy theme -->
        <link type="text/css" rel="stylesheet" href="slippy/src/slippy-pure.css"/>
        <!-- Syntax highlighting core file  -->
        <script type="text/javascript" src="slippy/src/highlighter/shCore.js"></script>
        <!-- Syntax highlighting brushes, remove those you don't need -->
        <script type="text/javascript" src="slippy/src/highlighter/shBrushPhp.js"></script>
        <script type="text/javascript" src="slippy/src/highlighter/shBrushJScript.js"></script>
        <script type="text/javascript" src="slippy/src/highlighter/shBrushXml.js"></script>
        <!-- Syntax highlighting styles-->
        <link type="text/css" rel="stylesheet" href="slippy/src/highlighter/shCore.css"/>
        <link type="text/css" rel="stylesheet" href="slippy/src/highlighter/shThemeEclipse.css"/>

        <style type="text/css">
            body > * {
                font-size: 1.2em;
            }

            body {
                background: #fff;
            }

            div.syntaxhighlighter {
                background: #aaa !important;
            }

            span.file {
                font-size: 0.8em;
                color: #f00;
                float: right;
                margin: -.2em .5em 0 0;
            }

            .smallcode {
                font-size: 0.8em;
            }

            strong {
                color: #662222;
            }

            li {
                line-height: 1.2em;
            }
            .footer, h1 {
                background: #eeeeee;
                border: solid #cccccc 1px;
                border-radius: 5px;
                padding: 8px;
            }
            .section h1 {
                background: #fff;
                border: none;
                font-size: 2em;
            }
            .footer {
                background: #fff;
                margin: 10px;
                margin-top: 0;
                width: 97%;
            }
        </style>
        <!-- Slippy init code -->
        <script type="text/javascript">
            $(function() {
                $(".slide").slippy({
                });
                SyntaxHighlighter.all();
            });
        </script>
    </head>

    <body>
        <div class="slide section">
            <h1>Advanced Symfony2</h1>
            <h2>Workshop</h2>
            <ul>
                <li>kernel - step through a request with Xdebug</li>
                <li>core events

- example: leute einen listener schreiben lassen (z.B. kernel.request listener der HEAD requests nach der security schon direkt beantwortet)
- custom events</li>
                <li>routing</li>
                <li>controller creation
- ControllerResolver
- kernel.controller</li>
                <li>bundle bootstrapping
- extension: service decorating
- prepend extension
- Configuration class
- example: compiler pass irgendwas mit tagging</li>
                <li>dependency injection container
- scopes
- synthetic services, private/public, lazy services
- example: service inheritance base abstract controller</li>
                <li>profiler
- example data collector: displaying requests made to some (external) API</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Kernel</h1>
            <ul>
                <li>Responsible to turn a Request instance into a Response instance</li>
                <li>Must implement the <a href="https://github.com/symfony/HttpKernel/blob/master/HttpKernelInterface.php#L24" target="_new">HttpKernelInterface</a></li>
                <li>Custom logic is implemented in Bundles</li>
                <li>Makes extensive use of events to allow for extensibility</li>
                <li>Note: A Request might lead to any number of Sub-Requests</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Kernel request processing</h1>
            <ol>
                <li>Trigger kernel.request event, if a Response was set jump to 8</li>
                <li>Use the ControllerResolver to determine the controller to execute</li>
                <li>Trigger the kernel.controller event</li>
                <li>Kernel calls the controller</li>
                <li>Trigger kernel.view event, if the Controller does not return a Response</li>
                <li>Trigger kernel.response event</li>
                <li>Return the Response</li>
            </ol>
        </div>

        <div class="slide">
            <h1>Kernel Events</h1>
            <ul>
                <li>kernel.request</li>
                <li>kernel.controller</li>
                <li>kernel.view (*)</li>
                <li>kernel.response</li>
                <li>kernel.terminate (*)</li>
                <li>kernel.exception (*)</li>
            </ul>
        </div>

        <div class="slide">
            <h1>Configuring a Kernel Events</h1>

            <pre class="brush: js">
                acme.demo.request_head_listener:
                    class: Acme\DemoBundle\EventListener\MyListener
                    tags:
                        - {
                            name: kernel.event_listener,
                            event: kernel.request,
                            method: onKernelRequest,
                            priority: -129
                        }
            </pre>
        </div>

        <div class="slide">
            <h1>Listener can subscribe to events themselves</h1>
            <pre class="brush: php">
                class MyListener implements EventSubscriberInterface
                {
                    public static function getSubscribedEvents()
                    {
                        return array(
                            KernelEvents::REQUEST => array(
                                'onKernelRequest', -129
                            )
                        );
                    }
                }
            </pre>
            <pre class="brush: js">
                acme.demo.request_head_listener:
                    class: Acme\DemoBundle\EventListener\MyListener
                    tags:
                        - {
                            name: kernel.event_subscribe
                        }
            </pre>
        </div>

        <div class="slide">
            <h1>Exercise: Write a custom listener</h1>
            <ul>
                <li>Scenario: We are using a reverse proxy in front of a website with a complex authentication and permission scheme</li>
                <li>Solution: Rewrite all GET Requests to HEAD Requests, check for a 200 Response before serving content from the cache</li>
                <li>Implementation: Write a listener for the kernel.request event. Ensure this listener has a lower priority than the firewall listener (priority 8). Return a 200 Response for any HEAD Request.</li>
                <li>Documentation: <a href="http://symfony.com/doc/current/book/internals.html#events">Internals: Events</a></li>
            </ul>
        </div>

        <div class="slide">
            <h1>Routing</h1>
            <ul>
                <li>Required and optional placeholders</li>
                <li>Route requirements</li>
                <li>Host matching</li>
                <li>Custom route loader</li>
            </ul>
        </div>

        <div class="slide">
            <h2>Required and optional placeholders</h2>

            <p>Placeholders are only optional if they have a default and are at the end of the pattern.</p>
            <p>For multiple optional placeholders each one must have a default and be separated by a single delimiter.</p>

            <pre class="brush: js">
                blog:
                    path:      /blog/{page}
                    defaults:  { _controller: AcmeDemoBundle:Blog:index, page: 1 }
            </pre>

            <p>Will match <code>/blog</code> (page=1) and <code>/blog/3</code> (page=3), but not <code>/blog/</code>.</p>

            <pre class="brush: js">
                blog_categories:
                    path:      /blog/{category1}/{category2}/{category3}
                    defaults:  { _controller: AcmeDemoBundle:Blog:byCategories, category2: "", category3: "" }
            </pre>

            <p>Will match <code>/blog/php</code> and <code>/blog/php/symfony</code> and<code>/blog/php/symfony/ezpublish</code>, but not <code>/blog</code>.</p>

            <!-- <p>Sometimes it is necessary to create multiple routes for the same thing to achieve the desired result. For example for optional parts in the middle of the path.</p> -->
            <p>Do you see a problem when using both these routes?</p>
        </div>

        <div class="slide">
            <h2>Route requirements</h2>

            <p><code>/blog/php</code> will match route "blog" (page=php) instead of "blog_categories".</p>
            <p>Route order matters! Route matching happens the order you define them. So if you have routes that overlap, later routes might never match.</p>
            <p>Solution: Careful crafting of route order, paths and requirements.</p>
        </div>

        <div class="slide">
            <h2>Default route requirements</h2>

            <p>By default, a route matches any HTTP method, any scheme and any host/domain.</p>

            <pre class="brush: js">
                blog_article:
                    path:      /blog/{slug}.{_format}
                    defaults:  { _controller: AcmeDemoBundle:Blog:article, _format: html }
            </pre>

            <p>What is the default requirement (regex) for <code>slug</code> and <code>_format</code>?</p>
            <p>app/console router:debug blog_article</p>
            <p>Path-Regex: <code>#^/blog/(?P&lt;slug&gt;[^/\.]++)(?:\.(?P&lt;_format&gt;[^/]++))?$#s</code></p>
            <p>slug: <code>[^/\.]++</code></p>
            <p>_format: <code>[^/]++</code></p>
        </div>

        <div class="slide">
            <h2>Custom route requirements</h2>

            <pre class="brush: js">
                blog_archive:
                    path:      /blog/{date}
                    defaults:  { _controller: AcmeDemoBundle:Blog:byDate }
                    methods:   [GET, PUT] # HEAD implicit
                    schemes:   https
                    requirements:
                        date:  \d{4}-\d{1,2}-\d{1,2}
            </pre>

            <p>By overriding the default requirement, you can also allow a "/" character in a placeholder.</p>
        </div>

        <div class="slide">
            <h2>Host matching</h2>

            <pre class="brush: js">
                user_profile:
                    path:     /
                    host:     {user}.%domain%
                    defaults: { _controller: AcmeDemoBundle:User:profile }
            </pre>

            <pre class="brush: js">
                parameters:
                    domain: example.com
            </pre>

            <p>The host option uses the same pattern style like path. But it doesn't support optional placeholders yet.</p>
            <p>It makes the domain configurable via service container parameters so you can change it depending on the environment.</p>

            <pre class="brush: xml">
                <a href="{{ path('user_profile', {'user': user.slug}) }}">Profile</a>
            </pre>

            <p>It will automatically generate an absolute URL when the resulting host is different from the current.</p>
            <!-- <p>So you can change the route definition and for example put the user placeholder in the path without needing to change your code/template.
            This abstraction is one of the main points of using the routing component.</p> -->
        </div>

        <div class="slide">
            <h2>Custom route loader</h2>

            <p>Exercise: Create a route loader that loads routes based on the file system structure. The directories and files represent the URL path segments.
            The file itself contains the Controller class and a "getAction" method that is executed for a GET request on the corresponding route. The routes
            are static because placeholders do not exist.
            </p>

            <p>Example: Given a directory structure of
            <pre>
├── routes
│   ├── about
│   │   ├── ezpublish.php
│   │   └── symfony.php
│   └── news.php
            </pre>
            it should create three routes (<code>/about/ezpublish</code>, <code>/about/symfony</code>, <code>/news</code>) when the directory <code>/routes</code>
            is configured as base directory to load routes from.
            </p>

            <p>Documentation of how to implement a custom route loader:
                <a href="http://symfony.com/doc/current/cookbook/routing/custom_route_loader.html">http://symfony.com/doc/current/cookbook/routing/custom_route_loader.html</a></p>
        </div>

        <div class="footer">
            <span class="left"><a href="http://ezsummercamp.com/">eZ Publish Summer Camp 2013</a><br/><a href="http://ezsummercamp.com/program/advanced_symfony2">Advanced Symfony2</a></span>
            <span class="right"><a href="http://pooteeweet.org/">Lukas Kahwe Smith</a><br/><a href="https://github.com/Tobion">Tobias Schultze</a></span>
            <hr class="defloat" />
        </div>
    </body>
</html>
